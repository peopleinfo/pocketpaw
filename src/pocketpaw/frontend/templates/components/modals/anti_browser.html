<!--
  PocketPaw Dashboard - Anti-Detect Browser Drawer

  Created: 2026-02-22
  Full-screen drawer with profile list + launch panel with actor templates.
  Crawlee-powered anti-detect browser profiles with fingerprint spoofing.
-->
<!-- Anti-Browser Full-Screen Drawer -->
<div
  class="fixed inset-0 z-[100] flex bg-black/40 backdrop-blur-md"
  x-show="antiBrowser.show"
  x-transition.opacity
  @click.self="antiBrowser.show = false"
>
  <div
    class="w-full h-full flex bg-[#1c1c1e]/98 backdrop-blur-xl animate-[modalPop_0.25s_ease-out] overflow-hidden"
    @click.stop
  >
    <!-- ==================== Left Panel: Profile List ==================== -->
    <div class="w-[320px] flex flex-col border-r border-white/5 shrink-0">
      <!-- Header -->
      <div
        class="flex items-center justify-between px-5 py-4 border-b border-white/5"
      >
        <div class="flex items-center gap-2.5">
          <i data-lucide="shield" class="w-5 h-5 text-accent"></i>
          <h2 class="text-[16px] font-semibold">Anti-Browser</h2>
        </div>
        <button
          class="p-2 -mr-2 text-white/40 hover:text-white hover:bg-white/10 rounded-lg transition-colors"
          @click="antiBrowser.show = false"
        >
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>

      <!-- Search + New -->
      <div class="px-4 py-3 flex items-center gap-2">
        <input
          type="text"
          x-model="antiBrowser.search"
          placeholder="Search profiles..."
          class="flex-1 px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-[12px] text-white placeholder-white/30 focus:border-accent focus:outline-none"
        />
        <button
          class="p-2 bg-accent/20 text-accent hover:bg-accent/30 rounded-lg transition-colors shrink-0"
          @click="antiBrowser.view = 'create'; antiBrowser.selectedProfile = null; $nextTick(() => { if (window.refreshIcons) window.refreshIcons(); })"
          title="New Profile"
        >
          <i data-lucide="plus" class="w-4 h-4"></i>
        </button>
      </div>

      <!-- Profile List -->
      <div class="flex-1 overflow-y-auto px-3 pb-3 space-y-1.5">
        <template
          x-for="profile in filteredAntiBrowserProfiles()"
          :key="profile.id"
        >
          <div
            class="group flex items-center gap-3 p-3 rounded-xl cursor-pointer transition-all"
            :class="antiBrowser.selectedProfile?.id === profile.id ? 'bg-accent/10 border border-accent/30' : 'bg-white/[0.02] border border-transparent hover:bg-white/[0.04] hover:border-white/10'"
            @click="selectAntiBrowserProfile(profile)"
          >
            <!-- Status dot -->
            <span
              class="w-2.5 h-2.5 rounded-full shrink-0"
              :class="profile.status === 'RUNNING' ? 'bg-green-400 animate-pulse' : profile.status === 'ERROR' ? 'bg-red-400' : 'bg-white/20'"
            ></span>
            <!-- Info -->
            <div class="flex-1 min-w-0">
              <div
                class="font-medium text-[13px] truncate"
                x-text="profile.name"
              ></div>
              <div class="flex items-center gap-2 mt-0.5">
                <span
                  class="text-[10px] text-white/40 capitalize"
                  x-text="profile.plugin"
                ></span>
                <template x-if="profile.proxy">
                  <span class="text-[10px] text-blue-400/60">⬤ proxy</span>
                </template>
              </div>
            </div>
            <!-- Status badge -->
            <span
              class="px-1.5 py-0.5 text-[9px] font-bold uppercase tracking-wider rounded-full shrink-0"
              :class="profile.status === 'RUNNING' ? 'bg-green-500/20 text-green-400' : profile.status === 'ERROR' ? 'bg-red-500/20 text-red-400' : 'bg-white/10 text-white/40'"
              x-text="profile.status"
            ></span>
          </div>
        </template>

        <!-- Empty state -->
        <template
          x-if="antiBrowser.profiles.length === 0 && !antiBrowser.loading"
        >
          <div class="text-center py-12">
            <div
              class="w-12 h-12 rounded-2xl bg-white/5 flex items-center justify-center mx-auto mb-4"
            >
              <i data-lucide="shield-off" class="w-6 h-6 text-white/30"></i>
            </div>
            <h3 class="text-[13px] font-semibold text-white/50 mb-2">
              No Profiles Yet
            </h3>
            <p class="text-[11px] text-white/30 mb-4 px-4 leading-relaxed">
              Create browser profiles with unique fingerprints, cookies, and
              proxy settings.
            </p>
            <button
              class="px-3 py-1.5 text-[12px] font-medium bg-accent text-white rounded-lg hover:bg-accent/90 transition-colors"
              @click="antiBrowser.view = 'create'; $nextTick(() => { if (window.refreshIcons) window.refreshIcons(); })"
            >
              Create First Profile
            </button>
          </div>
        </template>
      </div>
    </div>

    <!-- ==================== Right Panel: Detail / Create / Launch ==================== -->
    <div class="flex-1 flex flex-col overflow-hidden">
      <!-- No profile selected -->
      <template
        x-if="!antiBrowser.selectedProfile && antiBrowser.view !== 'create'"
      >
        <div
          class="flex-1 flex flex-col items-center justify-center text-white/20"
        >
          <i data-lucide="mouse-pointer-click" class="w-10 h-10 mb-4"></i>
          <p class="text-[14px]">Select a profile or create a new one</p>
        </div>
      </template>

      <!-- ===== Create Profile Form ===== -->
      <template x-if="antiBrowser.view === 'create'">
        <div class="flex-1 overflow-y-auto p-6">
          <h3 class="text-[15px] font-semibold mb-5 flex items-center gap-2">
            <i data-lucide="plus-circle" class="w-4 h-4 text-accent"></i> New
            Profile
          </h3>
          <div class="flex flex-col gap-4 max-w-[480px]">
            <div>
              <label class="text-[11px] text-white/50 mb-1 block">Name *</label>
              <input
                type="text"
                x-model="antiBrowser.form.name"
                placeholder="e.g. news-reader"
                class="w-full px-3 py-2.5 bg-black/30 border border-white/10 rounded-lg text-[13px] text-white placeholder-white/30 focus:border-accent focus:outline-none"
              />
            </div>
            <div>
              <label class="text-[11px] text-white/50 mb-1 block"
                >Start URL</label
              >
              <input
                type="text"
                x-model="antiBrowser.form.start_url"
                placeholder="https://..."
                class="w-full px-3 py-2.5 bg-black/30 border border-white/10 rounded-lg text-[13px] text-white placeholder-white/30 focus:border-accent focus:outline-none"
              />
            </div>
            <div>
              <label class="text-[11px] text-white/50 mb-1 block">Proxy</label>
              <input
                type="text"
                x-model="antiBrowser.form.proxy"
                placeholder="socks5://host:port or http://host:port"
                class="w-full px-3 py-2.5 bg-black/30 border border-white/10 rounded-lg text-[13px] text-white placeholder-white/30 focus:border-accent focus:outline-none font-mono"
              />
            </div>
            <div class="grid grid-cols-3 gap-3">
              <div>
                <label class="text-[11px] text-white/50 mb-1 block">OS</label>
                <select
                  x-model="antiBrowser.form.os_type"
                  class="w-full px-3 py-2.5 bg-black/30 border border-white/10 rounded-lg text-[13px] text-white focus:border-accent focus:outline-none"
                >
                  <option value="macos">macOS</option>
                  <option value="windows">Windows</option>
                  <option value="linux">Linux</option>
                </select>
              </div>
              <div>
                <label class="text-[11px] text-white/50 mb-1 block"
                  >Browser</label
                >
                <select
                  x-model="antiBrowser.form.browser_type"
                  :disabled="antiBrowser.form.plugin === 'camoufox'"
                  class="w-full px-3 py-2.5 bg-black/30 border border-white/10 rounded-lg text-[13px] text-white focus:border-accent focus:outline-none disabled:opacity-50"
                >
                  <option value="chromium">Chromium</option>
                  <option value="firefox">Firefox</option>
                </select>
              </div>
              <div>
                <label class="text-[11px] text-white/50 mb-1 block"
                  >Plugin</label
                >
                <select
                  x-model="antiBrowser.form.plugin"
                  @change="if (antiBrowser.form.plugin === 'camoufox') antiBrowser.form.browser_type = 'firefox'"
                  class="w-full px-3 py-2.5 bg-black/30 border border-white/10 rounded-lg text-[13px] text-white focus:border-accent focus:outline-none"
                >
                  <template x-for="p in antiBrowser.plugins" :key="p.id">
                    <option
                      :value="p.id"
                      x-text="p.name"
                      :disabled="!p.installed"
                    ></option>
                  </template>
                </select>

                <!-- Missing Plugin Installers -->
                <div class="mt-2 space-y-2">
                  <template
                    x-for="p in antiBrowser.plugins.filter(p => !p.installed)"
                    :key="'install-'+p.id"
                  >
                    <div
                      class="flex items-center justify-between px-3 py-2 bg-white/5 border border-white/10 rounded-lg"
                    >
                      <div class="flex items-center gap-2">
                        <i
                          :data-lucide="p.icon"
                          class="w-3.5 h-3.5 text-white/50"
                        ></i>
                        <span
                          class="text-[12px] text-white/70"
                          x-text="`${p.name} is not installed`"
                        ></span>
                      </div>
                      <button
                        @click="installAntiBrowserPlugin(p.id)"
                        :disabled="p.installing"
                        class="px-2 py-1 bg-accent/20 text-accent hover:bg-accent/40 rounded text-[11px] font-medium transition-colors disabled:opacity-50"
                      >
                        <span x-show="!p.installing">Install</span>
                        <span
                          x-show="p.installing"
                          class="flex items-center gap-1"
                        >
                          <i
                            data-lucide="loader-2"
                            class="w-3 h-3 animate-spin"
                          ></i>
                        </span>
                      </button>
                    </div>
                  </template>
                </div>
              </div>
            </div>
            <div>
              <label class="text-[11px] text-white/50 mb-1 block">Notes</label>
              <textarea
                x-model="antiBrowser.form.notes"
                placeholder="Optional notes..."
                rows="2"
                class="w-full px-3 py-2.5 bg-black/30 border border-white/10 rounded-lg text-[13px] text-white placeholder-white/30 focus:border-accent focus:outline-none resize-none"
              ></textarea>
            </div>
            <div class="flex items-center gap-3 mt-2">
              <button
                @click="createAntiBrowserProfile()"
                :disabled="!antiBrowser.form.name.trim() || antiBrowser.creating"
                class="px-5 py-2.5 bg-accent text-white font-medium rounded-xl hover:bg-accent/90 transition-colors disabled:opacity-50 text-[13px]"
              >
                <span x-show="!antiBrowser.creating">Create Profile</span>
                <span x-show="antiBrowser.creating">Creating...</span>
              </button>
              <button
                class="text-[12px] text-white/40 hover:text-white/70 transition-colors"
                @click="antiBrowser.view = 'detail'"
              >
                Cancel
              </button>
            </div>
          </div>
        </div>
      </template>

      <!-- ===== Profile Detail + Launch Panel ===== -->
      <template
        x-if="antiBrowser.selectedProfile && antiBrowser.view !== 'create'"
      >
        <div class="flex-1 flex flex-col overflow-hidden">
          <!-- Profile Header -->
          <div
            class="flex items-center justify-between px-6 py-4 border-b border-white/5 bg-black/20 shrink-0"
          >
            <div class="flex items-center gap-3">
              <span
                class="w-3 h-3 rounded-full"
                :class="antiBrowser.selectedProfile.status === 'RUNNING' ? 'bg-green-400 animate-pulse' : 'bg-white/20'"
              ></span>
              <h3
                class="text-[15px] font-semibold"
                x-text="antiBrowser.selectedProfile.name"
              ></h3>
              <span
                class="px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wider rounded-full bg-white/10 text-white/50"
                x-text="antiBrowser.selectedProfile.plugin"
              ></span>
            </div>
            <div class="flex items-center gap-2">
              <button
                class="p-2 text-white/40 hover:text-red-400 hover:bg-red-500/10 rounded-lg transition-colors"
                @click="deleteAntiBrowserProfile(antiBrowser.selectedProfile.id)"
                title="Delete Profile"
              >
                <i data-lucide="trash-2" class="w-4 h-4"></i>
              </button>
            </div>
          </div>

          <!-- Content area -->
          <div class="flex-1 overflow-y-auto p-6">
            <div class="grid grid-cols-2 gap-6">
              <!-- Left: Profile Info -->
              <div class="flex flex-col gap-4">
                <h4
                  class="text-[12px] font-semibold uppercase tracking-wider text-white/40"
                >
                  Profile
                </h4>

                <!-- Fingerprint card -->
                <div class="bg-white/5 rounded-xl p-4 border border-white/5">
                  <div class="flex items-center justify-between mb-3">
                    <span
                      class="text-[11px] font-semibold text-white/50 uppercase tracking-wider"
                      >Fingerprint</span
                    >
                    <button
                      class="text-[10px] text-accent hover:text-accent/80 transition-colors"
                      @click="regenerateAntiBrowserFingerprint(antiBrowser.selectedProfile.id)"
                    >
                      Regenerate
                    </button>
                  </div>
                  <template x-if="antiBrowser.selectedProfile.fingerprint">
                    <div class="flex flex-col gap-1.5 text-[11px]">
                      <div class="flex items-center gap-2">
                        <span class="text-white/40 w-16">UA</span>
                        <span
                          class="text-white/70 truncate"
                          x-text="antiBrowser.selectedProfile.fingerprint.user_agent?.substring(0, 60) + '...'"
                        ></span>
                      </div>
                      <div class="flex items-center gap-2">
                        <span class="text-white/40 w-16">Viewport</span>
                        <span
                          class="text-white/70"
                          x-text="antiBrowser.selectedProfile.fingerprint.viewport ? antiBrowser.selectedProfile.fingerprint.viewport.width + '×' + antiBrowser.selectedProfile.fingerprint.viewport.height : 'N/A'"
                        ></span>
                      </div>
                      <div class="flex items-center gap-2">
                        <span class="text-white/40 w-16">Locale</span>
                        <span
                          class="text-white/70"
                          x-text="antiBrowser.selectedProfile.fingerprint.locale || 'en-US'"
                        ></span>
                      </div>
                      <div class="flex items-center gap-2">
                        <span class="text-white/40 w-16">Source</span>
                        <span
                          class="text-white/70 capitalize"
                          x-text="antiBrowser.selectedProfile.fingerprint.source || 'basic'"
                        ></span>
                      </div>
                    </div>
                  </template>
                </div>

                <!-- Quick info -->
                <div class="flex flex-col gap-2 text-[12px]">
                  <template x-if="antiBrowser.selectedProfile.proxy">
                    <div class="flex items-center gap-2">
                      <i
                        data-lucide="network"
                        class="w-3.5 h-3.5 text-blue-400/60"
                      ></i>
                      <span class="text-white/50">Proxy:</span>
                      <span
                        class="text-white/70 font-mono text-[11px]"
                        x-text="antiBrowser.selectedProfile.proxy"
                      ></span>
                    </div>
                  </template>
                  <template x-if="antiBrowser.selectedProfile.start_url">
                    <div class="flex items-center gap-2">
                      <i
                        data-lucide="link"
                        class="w-3.5 h-3.5 text-white/40"
                      ></i>
                      <span class="text-white/50">Start:</span>
                      <span
                        class="text-white/70 truncate"
                        x-text="antiBrowser.selectedProfile.start_url"
                      ></span>
                    </div>
                  </template>
                  <div class="flex items-center gap-2">
                    <i
                      data-lucide="clock"
                      class="w-3.5 h-3.5 text-white/40"
                    ></i>
                    <span class="text-white/50">Last used:</span>
                    <span
                      class="text-white/70"
                      x-text="antiBrowser.selectedProfile.last_used_at ? new Date(antiBrowser.selectedProfile.last_used_at).toLocaleDateString() : 'Never'"
                    ></span>
                  </div>
                </div>
              </div>

              <!-- Right: Actor Templates -->
              <div class="flex flex-col gap-4">
                <h4
                  class="text-[12px] font-semibold uppercase tracking-wider text-white/40"
                >
                  Run Actor Template
                </h4>

                <!-- Actor template cards -->
                <div class="flex flex-col gap-2">
                  <template x-for="actor in antiBrowser.actors" :key="actor.id">
                    <div
                      class="p-3 rounded-xl cursor-pointer transition-all"
                      :class="antiBrowser.selectedActor === actor.id ? 'bg-accent/10 border border-accent/30' : 'bg-white/5 border border-white/5 hover:bg-white/[0.06] hover:border-white/10'"
                      @click="selectAntiBrowserActor(actor.id)"
                    >
                      <div class="flex items-center gap-3">
                        <div
                          class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center shrink-0"
                        >
                          <i
                            :data-lucide="actor.icon"
                            class="w-4 h-4 text-white/60"
                          ></i>
                        </div>
                        <div class="flex-1 min-w-0">
                          <div
                            class="font-medium text-[13px]"
                            x-text="actor.name"
                          ></div>
                          <div
                            class="text-[10px] text-white/40 truncate"
                            x-text="actor.description"
                          ></div>
                        </div>
                        <svg
                          x-show="antiBrowser.selectedActor === actor.id"
                          xmlns="http://www.w3.org/2000/svg"
                          width="16"
                          height="16"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          class="w-4 h-4 text-accent shrink-0"
                        >
                          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                          <polyline points="22 4 12 14.01 9 11.01" />
                        </svg>
                      </div>
                    </div>
                  </template>
                </div>

                <!-- Actor input form (dynamic from schema) -->
                <template
                  x-if="antiBrowser.selectedActor && antiBrowser.actorSchema"
                >
                  <div
                    class="flex flex-col gap-3 mt-2 p-4 bg-white/5 rounded-xl border border-white/5"
                  >
                    <h5
                      class="text-[11px] font-semibold text-white/50 uppercase tracking-wider"
                    >
                      Options
                    </h5>
                    <template
                      x-for="(prop, key) in antiBrowser.actorSchema.properties || {}"
                      :key="key"
                    >
                      <div>
                        <label
                          class="text-[11px] text-white/50 mb-1 block"
                          x-text="prop.title || key"
                        ></label>
                        <!-- Textarea for multiline -->
                        <template
                          x-if="prop['ui:widget'] === 'textarea' || prop['ui:widget'] === 'code'"
                        >
                          <textarea
                            x-model="antiBrowser.actorInputs[key]"
                            :placeholder="prop.description || ''"
                            rows="3"
                            class="w-full px-3 py-2 bg-black/30 border border-white/10 rounded-lg text-[12px] text-white placeholder-white/30 focus:border-accent focus:outline-none resize-none font-mono"
                          ></textarea>
                        </template>
                        <!-- Select for enums -->
                        <template x-if="prop.enum">
                          <select
                            x-model="antiBrowser.actorInputs[key]"
                            class="w-full px-3 py-2 bg-black/30 border border-white/10 rounded-lg text-[12px] text-white focus:border-accent focus:outline-none"
                          >
                            <template x-for="opt in prop.enum" :key="opt">
                              <option :value="opt" x-text="opt"></option>
                            </template>
                          </select>
                        </template>
                        <!-- Checkbox for boolean -->
                        <template x-if="prop.type === 'boolean'">
                          <label class="flex items-center gap-2 cursor-pointer">
                            <input
                              type="checkbox"
                              x-model="antiBrowser.actorInputs[key]"
                              class="rounded border-white/20"
                            />
                            <span
                              class="text-[11px] text-white/60"
                              x-text="prop.description || ''"
                            ></span>
                          </label>
                        </template>
                        <!-- Number input -->
                        <template x-if="prop.type === 'integer' && !prop.enum">
                          <input
                            type="number"
                            x-model.number="antiBrowser.actorInputs[key]"
                            :placeholder="prop.default"
                            :min="prop.minimum"
                            :max="prop.maximum"
                            class="w-full px-3 py-2 bg-black/30 border border-white/10 rounded-lg text-[12px] text-white placeholder-white/30 focus:border-accent focus:outline-none"
                          />
                        </template>
                        <!-- Default text input -->
                        <template
                          x-if="prop.type === 'string' && !prop.enum && prop['ui:widget'] !== 'textarea' && prop['ui:widget'] !== 'code'"
                        >
                          <input
                            type="text"
                            x-model="antiBrowser.actorInputs[key]"
                            :placeholder="prop.description || ''"
                            class="w-full px-3 py-2 bg-black/30 border border-white/10 rounded-lg text-[12px] text-white placeholder-white/30 focus:border-accent focus:outline-none"
                          />
                        </template>
                      </div>
                    </template>

                    <!-- GO button -->
                    <button
                      @click="runAntiBrowserActor()"
                      :disabled="antiBrowser.running"
                      class="mt-2 px-6 py-3 bg-green-500 text-white font-bold rounded-xl hover:bg-green-400 transition-all disabled:opacity-50 text-[14px] flex items-center justify-center gap-2 shadow-lg shadow-green-500/20"
                    >
                      <i data-lucide="play" class="w-5 h-5"></i>
                      <span x-show="!antiBrowser.running">Go</span>
                      <span x-show="antiBrowser.running">Running...</span>
                    </button>
                  </div>
                </template>
              </div>
            </div>

            <!-- Results panel -->
            <template x-if="antiBrowser.lastResult">
              <div class="mt-6 p-4 bg-white/5 rounded-xl border border-white/5">
                <div class="flex items-center justify-between mb-3">
                  <h4
                    class="text-[12px] font-semibold text-white/50 uppercase tracking-wider"
                  >
                    Results
                  </h4>
                  <div class="flex items-center gap-3 text-[11px]">
                    <span class="text-white/40"
                      >Pages:
                      <span
                        class="text-white/70"
                        x-text="antiBrowser.lastResult.pages_crawled"
                      ></span
                    ></span>
                    <span class="text-white/40"
                      >Items:
                      <span
                        class="text-white/70"
                        x-text="antiBrowser.lastResult.items_extracted"
                      ></span
                    ></span>
                    <span
                      class="px-1.5 py-0.5 rounded text-[9px] font-bold uppercase"
                      :class="antiBrowser.lastResult.status === 'success' ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'"
                      x-text="antiBrowser.lastResult.status"
                    ></span>
                  </div>
                </div>
                <template x-if="antiBrowser.lastResult.error">
                  <div
                    class="text-[12px] text-red-400 mb-2"
                    x-text="antiBrowser.lastResult.error"
                  ></div>
                </template>
                <template
                  x-if="antiBrowser.lastResult.data && antiBrowser.lastResult.data.length > 0"
                >
                  <div class="max-h-[300px] overflow-y-auto">
                    <pre
                      class="text-[11px] text-white/70 font-mono whitespace-pre-wrap"
                      x-text="JSON.stringify(antiBrowser.lastResult.data, null, 2)"
                    ></pre>
                  </div>
                </template>
              </div>
            </template>
          </div>
        </div>
      </template>
    </div>
  </div>
</div>
